<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>政府採購網篩選器</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .data-table th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }
        
        .data-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .data-table tr:hover {
            background-color: #f1f1f1;
        }
        
        @media print {
            body {
                width: 100%;
                margin: 0;
                padding: 0;
            }
            
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100 p-4">
    <div class="container mx-auto bg-white p-6 rounded-lg shadow-lg">
        <h1 class="text-3xl font-bold mb-6 text-center text-blue-700">政府採購網篩選器</h1>
        
        <!-- Navigation Menu -->
        <div class="flex flex-wrap justify-center gap-2 mb-6 no-print">
            <button id="all-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                全部資料
            </button>
            <button id="health-bureau-btn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                衛生局
            </button>
            <button id="mohw-btn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                衛生福利部
            </button>
            <button id="hpa-btn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                國民健康署
            </button>
            <button id="hospital-btn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                醫院
            </button>
        </div>
        
        <!-- Search and Sort Controls -->
        <div class="flex flex-wrap justify-between items-center mb-6 no-print">
            <div class="flex items-center gap-2">
                <input id="custom-search" type="text" placeholder="輸入關鍵字..."
                    class="border border-gray-300 p-2 rounded" />
                <button id="search-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    搜尋
                </button>
            </div>
            
            <div class="flex items-center gap-2 mt-2 sm:mt-0">
                <span class="text-gray-700">排序方式:</span>
                <select id="sort-by" class="border border-gray-300 p-2 rounded">
                    <option value="default">預設排序</option>
                    <option value="bidDate">招標日期</option>
                    <option value="deadlineDate">截標日期</option>
                    <option value="amount">金額</option>
                </select>
                <button id="sort-btn" class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded">
                    排序
                </button>
            </div>
        </div>
        
        <!-- Status Display -->
        <div id="status" class="text-center text-gray-700 mb-4">
            載入中...
        </div>
        
        <!-- Loading Spinner -->
        <div id="loader" class="loader"></div>
        
        <!-- Results Counter -->
        <div id="results-count" class="text-right text-gray-700 mb-2 hidden">
            共找到 <span id="count">0</span> 筆資料
        </div>
        
        <!-- Data Table -->
        <div class="overflow-x-auto">
            <table id="data-table" class="data-table hidden">
                <thead>
                    <tr>
                        <th>序號</th>
                        <th>標案名稱</th>
                        <th>機關名稱</th>
                        <th>招標方式</th>
                        <th>招標日期</th>
                        <th>截標日期</th>
                        <th>預算金額</th>
                        <th>詳細資料</th>
                    </tr>
                </thead>
                <tbody id="data-body">
                    <!-- Data will be inserted here via JavaScript -->
                </tbody>
            </table>
        </div>
        
        <noscript>
            <div class="text-center text-red-600 p-4 border border-red-300 rounded mt-4">
                此頁面需要啟用 JavaScript 才能正常運作。請啟用您瀏覽器的 JavaScript 功能。
            </div>
        </noscript>
    </div>

    <script>
        // Global variables
        let allData = [];
        let filteredData = [];
        let currentFilter = '';
        
        // DOM Elements
        const loader = document.getElementById('loader');
        const status = document.getElementById('status');
        const dataTable = document.getElementById('data-table');
        const dataBody = document.getElementById('data-body');
        const resultsCount = document.getElementById('results-count');
        const countSpan = document.getElementById('count');
        
        // Buttons
        const allBtn = document.getElementById('all-btn');
        const healthBureauBtn = document.getElementById('health-bureau-btn');
        const mohwBtn = document.getElementById('mohw-btn');
        const hpaBtn = document.getElementById('hpa-btn');
        const hospitalBtn = document.getElementById('hospital-btn');
        const searchBtn = document.getElementById('search-btn');
        const sortBtn = document.getElementById('sort-btn');
        
        // Input elements
        const customSearch = document.getElementById('custom-search');
        const sortBy = document.getElementById('sort-by');
        
        // Initialize page - Load data when page loads
        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
            
            // Add event listeners to buttons
            allBtn.addEventListener('click', () => filterData(''));
            healthBureauBtn.addEventListener('click', () => filterData('衛生局'));
            mohwBtn.addEventListener('click', () => filterData('衛生福利部'));
            hpaBtn.addEventListener('click', () => filterData('國民健康署'));
            hospitalBtn.addEventListener('click', () => filterData('醫院'));
            
            searchBtn.addEventListener('click', () => {
                const keyword = customSearch.value.trim();
                filterData(keyword);
            });
            
            customSearch.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const keyword = customSearch.value.trim();
                    filterData(keyword);
                }
            });
            
            sortBtn.addEventListener('click', sortData);
        });
        
        // Fetch data from government procurement website
        async function fetchData() {
            showLoading(true);
            status.textContent = '正在從政府採購網抓取資料...';
            
            try {
                // Using a CORS proxy to fetch data
                // Try multiple proxy services in case one fails
                const proxyUrls = [
                    'https://corsproxy.io/?',
                    'https://api.allorigins.win/raw?url=',
                    'https://cors-anywhere.herokuapp.com/'
                ];
                
                const targetUrl = 'https://web.pcc.gov.tw/prkms/today/common/todayTender';
                let html = '';
                let success = false;
                
                // Try each proxy until successful
                for (const proxyUrl of proxyUrls) {
                    try {
                        const response = await fetch(proxyUrl + encodeURIComponent(targetUrl));
                        
                        if (response.ok) {
                            html = await response.text();
                            success = true;
                            break;
                        }
                    } catch (err) {
                        console.warn(`Proxy ${proxyUrl} failed:`, err);
                    }
                }
                
                if (!success) {
                    // If all proxies fail, try direct fetch (might still fail due to CORS)
                    try {
                        const response = await fetch(targetUrl);
                        if (response.ok) {
                            html = await response.text();
                            success = true;
                        }
                    } catch (directErr) {
                        console.warn('Direct fetch failed:', directErr);
                    }
                }
                
                if (!success) {
                    throw new Error('無法從政府採購網取得資料');
                }
                
                // Parse the HTML data
                allData = parseHtmlData(html);
                
                // Display all data initially
                filteredData = [...allData];
                displayData(filteredData);
                
                status.textContent = '資料載入完成';
                showLoading(false);
                
            } catch (error) {
                console.error('Error fetching data:', error);
                status.textContent = `發生錯誤: ${error.message}。使用示範資料...`;
                
                // Use sample data if fetching fails
                allData = getSampleData();
                filteredData = [...allData];
                displayData(filteredData);
                
                showLoading(false);
            }
        }
        
        // Parse HTML data from the government procurement website
        function parseHtmlData(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Find all tables in the document
            const tables = doc.querySelectorAll('table');
            let tenderTable = null;
            
            // Find the table with tender data (looking for a table with relevant headers)
            for (const table of tables) {
                const headerText = table.textContent.toLowerCase();
                if (headerText.includes('標案名稱') || 
                    headerText.includes('機關名稱') || 
                    headerText.includes('招標方式')) {
                    tenderTable = table;
                    break;
                }
            }
            
            if (!tenderTable) {
                throw new Error('無法找到標案資料表格');
            }
            
            const rows = tenderTable.querySelectorAll('tr');
            const data = [];
            let headerRow = true;
            let nameIdx = 0, orgIdx = 1, methodIdx = 2, bidDateIdx = 3, deadlineDateIdx = 4, amountIdx = 5;
            
            // Process each row in the table
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const cells = row.querySelectorAll('td, th');
                
                // Skip empty rows
                if (cells.length < 6) continue;
                
                // Try to identify header row and column indices
                if (headerRow) {
                    for (let j = 0; j < cells.length; j++) {
                        const cellText = cells[j].textContent.trim().toLowerCase();
                        if (cellText.includes('標案名稱')) nameIdx = j;
                        else if (cellText.includes('機關名稱')) orgIdx = j;
                        else if (cellText.includes('招標方式')) methodIdx = j;
                        else if (cellText.includes('招標日期')) bidDateIdx = j;
                        else if (cellText.includes('截止日期') || cellText.includes('截標日期')) deadlineDateIdx = j;
                        else if (cellText.includes('預算金額') || cellText.includes('金額')) amountIdx = j;
                    }
                    headerRow = false;
                    continue;
                }
                
                // Process data rows
                const item = {
                    id: data.length + 1,
                    name: cells[nameIdx]?.textContent.trim() || '',
                    organization: cells[orgIdx]?.textContent.trim() || '',
                    method: cells[methodIdx]?.textContent.trim() || '',
                    bidDate: cells[bidDateIdx]?.textContent.trim() || '',
                    deadlineDate: cells[deadlineDateIdx]?.textContent.trim() || '',
                    amount: parseAmount(cells[amountIdx]?.textContent.trim() || ''),
                    detailLink: findLinkInCell(cells) || '#'
                };
                
                data.push(item);
            }
            
            return data;
        }
        
        // Find link in table cell
        function findLinkInCell(cells) {
            for (const cell of cells) {
                const link = cell.querySelector('a');
                if (link && link.href) {
                    return link.href;
                }
            }
            return null;
        }
        
        // Parse amount string to number
        function parseAmount(amountStr) {
            const num = amountStr.replace(/[^\d]/g, '');
            return num ? parseInt(num) : 0;
        }
        
        // Get sample data if fetching fails
        function getSampleData() {
            return [
                {
                    id: 1,
                    name: '臺中市西區衛生所建置牙科設備財物採購案',
                    organization: '臺中市西區衛生所',
                    method: '公開取得報價單或企劃書',
                    bidDate: '113/04/12',
                    deadlineDate: '113/04/19',
                    amount: 980000,
                    detailLink: 'https://web.pcc.gov.tw/tps/main/pms/tps/atm/atmAwardAction.do?newEdit=false&searchMode=common&method=inquiryForPublic&pkAtmMain=53329124&tenderCaseNo=AU01-112-0038'
                },
                {
                    id: 2,
                    name: '113年度精神疾病嚴重病人強制住院及強制社區治療審查會委員出席費',
                    organization: '衛生福利部',
                    method: '限制性招標',
                    bidDate: '113/04/10',
                    deadlineDate: '113/12/31',
                    amount: 560000,
                    detailLink: 'https://web.pcc.gov.tw/tps/main/pms/tps/atm/atmAwardAction.do?newEdit=false&searchMode=common&method=inquiryForPublic&pkAtmMain=53329125&tenderCaseNo=A113054'
                },
                {
                    id: 3,
                    name: '113年度癌症篩檢與品質提升計畫:更新癌症篩檢治療追蹤資料庫功能',
                    organization: '國民健康署',
                    method: '限制性招標',
                    bidDate: '113/04/15',
                    deadlineDate: '113/04/22',
                    amount: 1200000,
                    detailLink: 'https://web.pcc.gov.tw/tps/main/pms/tps/atm/atmAwardAction.do?newEdit=false&searchMode=common&method=inquiryForPublic&pkAtmMain=53329126&tenderCaseNo=H1130401'
                },
                {
                    id: 4,
                    name: '113年度門診手術室消毒滅菌設備採購',
                    organization: '臺北市立聯合醫院',
                    method: '公開招標',
                    bidDate: '113/04/08',
                    deadlineDate: '113/04/24',
                    amount: 3500000,
                    detailLink: 'https://web.pcc.gov.tw/tps/main/pms/tps/atm/atmAwardAction.do?newEdit=false&searchMode=common&method=inquiryForPublic&pkAtmMain=53329127&tenderCaseNo=TP-113-058'
                },
                {
                    id: 5,
                    name: '113年醫院感染管制查核作業及查核委員相關事務',
                    organization: '疾病管制署',
                    method: '限制性招標',
                    bidDate: '113/04/11',
                    deadlineDate: '113/04/25',
                    amount: 1800000,
                    detailLink: 'https://web.pcc.gov.tw/tps/main/pms/tps/atm/atmAwardAction.do?newEdit=false&searchMode=common&method=inquiryForPublic&pkAtmMain=53329128&tenderCaseNo=CDC-113-025'
                },
                {
                    id: 6,
                    name: '113年度食品業者登錄平台系統維護',
                    organization: '食品藥物管理署',
                    method: '限制性招標',
                    bidDate: '113/04/09',
                    deadlineDate: '113/12/31',
                    amount: 950000,
                    detailLink: 'https://web.pcc.gov.tw/tps/main/pms/tps/atm/atmAwardAction.do?newEdit=false&searchMode=common&method=inquiryForPublic&pkAtmMain=53329129&tenderCaseNo=FDA-113-015'
                },
                {
                    id: 7,
                    name: '南投縣衛生局113年度行政大樓清潔維護',
                    organization: '南投縣衛生局',
                    method: '公開取得報價單或企劃書',
                    bidDate: '113/04/10',
                    deadlineDate: '113/04/20',
                    amount: 750000,
                    detailLink: 'https://web.pcc.gov.tw/tps/main/pms/tps/atm/atmAwardAction.do?newEdit=false&searchMode=common&method=inquiryForPublic&pkAtmMain=53329130&tenderCaseNo=NT-113-012'
                }
            ];
        }
        
        // Filter data based on keyword
        function filterData(keyword) {
            currentFilter = keyword;
            
            if (!keyword) {
                filteredData = [...allData];
            } else {
                filteredData = allData.filter(item => 
                    item.organization.includes(keyword)
                );
            }
            
            displayData(filteredData);
        }
        
        // Sort data
        function sortData() {
            const sortType = sortBy.value;
            
            switch (sortType) {
                case 'bidDate':
                    filteredData.sort((a, b) => {
                        return compareDates(a.bidDate, b.bidDate);
                    });
                    break;
                case 'deadlineDate':
                    filteredData.sort((a, b) => {
                        return compareDates(a.deadlineDate, b.deadlineDate);
                    });
                    break;
                case 'amount':
                    filteredData.sort((a, b) => b.amount - a.amount);
                    break;
                default:
                    // Default sort by ID
                    filteredData.sort((a, b) => a.id - b.id);
            }
            
            displayData(filteredData);
        }
        
        // Compare dates for sorting
        function compareDates(dateA, dateB) {
            // Convert Chinese dates to Date objects for comparison
            // Assume format is like "113/04/01" (ROC year)
            const parseDate = (dateStr) => {
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    // Convert ROC year to Gregorian year (add 1911)
                    const year = parseInt(parts[0]) + 1911;
                    const month = parseInt(parts[1]) - 1; // JavaScript months are 0-based
                    const day = parseInt(parts[2]);
                    return new Date(year, month, day);
                }
                return new Date(0); // Invalid date returns earliest date
            };
            
            return parseDate(dateA) - parseDate(dateB);
        }
        
        // Display data in the table
        function displayData(data) {
            dataBody.innerHTML = '';
            
            if (data.length === 0) {
                status.textContent = '沒有找到符合條件的資料';
                dataTable.classList.add('hidden');
                resultsCount.classList.add('hidden');
                return;
            }
            
            data.forEach((item, index) => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.name}</td>
                    <td>${item.organization}</td>
                    <td>${item.method}</td>
                    <td>${item.bidDate}</td>
                    <td>${item.deadlineDate}</td>
                    <td>${formatAmount(item.amount)}</td>
                    <td><a href="${item.detailLink}" target="_blank" class="text-blue-600 hover:text-blue-800">查看</a></td>
                `;
                
                dataBody.appendChild(row);
            });
            
            dataTable.classList.remove('hidden');
            resultsCount.classList.remove('hidden');
            countSpan.textContent = data.length;
            
            if (currentFilter) {
                status.textContent = `已篩選出含有 "${currentFilter}" 的機關標案`;
            } else {
                status.textContent = '顯示全部資料';
            }
        }
        
        // Format amount number to readable string
        function formatAmount(amount) {
            return amount.toLocaleString('zh-TW') + ' 元';
        }
        
        // Show or hide loading indicator
        function showLoading(isLoading) {
            if (isLoading) {
                loader.style.display = 'block';
                dataTable.classList.add('hidden');
                resultsCount.classList.add('hidden');
            } else {
                loader.style.display = 'none';
            }
        }
    </script>
</body>
</html>
